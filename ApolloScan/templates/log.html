{% extends "scan_page.html" %}

{%block loader_header %}

<!-- DataTables CSS -->
<link href="../../static/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css" rel="stylesheet">
<script src="../../static/bower_components/jquery/dist/jquery.min.js"></script>
<script src="../../static/bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="../../static/bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>


<style>
.div-relative{position:relative; color:#000; border:1px solid #000; width:100%; height:400px}
.div-a{ position:absolute; width:100%; height:100%}
.div-b{ position:absolute; display: none; background-color:rgba(0, 0, 0, 0.3); width:100%; height:100%}
.table-nonfluid {
   text-align: center;
}
.spinner {
  width: 80px;
  height: 80px;
  margin: 100px auto;
  background-color: #333;

  border-radius: 100%;
  -webkit-animation: scaleout 1.0s infinite ease-in-out;
  animation: scaleout 1.0s infinite ease-in-out;
}

@-webkit-keyframes scaleout {
  0% { -webkit-transform: scale(0.0) }
  100% {
    -webkit-transform: scale(1.0);
    opacity: 0;
  }
}

@keyframes scaleout {
  0% {
    transform: scale(0.0);
    -webkit-transform: scale(0.0);
  } 100% {
    transform: scale(1.0);
    -webkit-transform: scale(1.0);
    opacity: 0;
  }
}
</style>
{% endblock %}

{%block loader_content %}
<div class="row">
  <div class="col-lg-12">
      <h1 class="page-header">{{title}}</h1>
  </div>
  <!-- /.col-lg-12 -->
</div>
<div class="row">
  <div class="col-lg-12">
      <div class="panel panel-default">
          <div class="panel-heading">
              DataTables Logs Tables
          </div>
          <!-- /.panel-heading -->
          <div class="panel-body">
              <div class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                <div class="dataTables_length" id="dataTables-example_length">
                <!-- <button id="redraw" style="width: 50px;height: 25px">刷新</button> -->
                <div class="col-sm-12">
                  <table class="table table-striped table-bordered table-hover dataTable no-footer table-nonfluid" id="dataTables-example" role="grid" width="100%">
                   <thead>
                    <tr role="row">
                        <th></th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>I/U</th>
                        <th>Platform</th>
                        <th>Size</th>
                        <th>Status</th>
                        <th>File</th>
                    </tr>
                   </thead>
                   <tbody></tbody>
                   <!-- tbody是必须的 -->
                 </table>
               </div>

              </div>
            </div>
          </div>
          <!-- /.panel-body -->
      </div>
      <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>


<div class="row">
  <div class="col-lg-12">
      <div class="panel panel-default">
          <div class="panel-body">
            <div class="div-relative">
              <div class="div-a">
                <iframe id="frame_content" width="100%" height="100%"></iframe>
              </div>
              <div class="div-b" id='frame_progress'>
                <div class="spinner"></div>
              </div>
            </div>
          </div>
          <!-- /.panel-body -->
      </div>
      <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
{% endblock %}

{%block loader_javascript %}

<script type="text/javascript">
/*Javascript代码片段*/
var t = $('#dataTables-example').DataTable({
    ajax: {
        //指定数据源
        url: "../../scan/api/?action=loglist",
        data: {
            'action': 'loglist',
        },
    },
    //每页显示三条数据
    pageLength: 3,
    columns: [{
        "data": null //此列不绑定数据源，用来显示序号
    },
    {
        "data": "time"
    },
    {
        "data": "duration"
    },
    {
        "data": "rc_db_changed"
    },
    {
        "data": "platform"
    },
    {
        "data": "file_size"
    },
    {
        "data": "log_error"
    },
    {
        "data": "file"
    }],
    "lengthMenu": [[3, 6, 20, 50, -1], [3, 6, 20, 50, "All"]],
    "columnDefs": [{
         //"visible": false,
         //"targets": 0
    },
    {
        "render": function(data, type, row, meta) {
            if (row.log_error > 0){
              return '<button type="button" class="btn btn-danger" disabled="disabled">Error ' +row.log_error+'</button>';
            }else{
              return '<button type="button" class="btn btn-success" disabled="disabled">Success</button>'
            }
        },
        "targets": 6
    },
    {
        "render": function(data, type, row, meta) {
            return '<button type="button" class="btn btn-primary btn-sm" onclick="javascript:showlog(\''+row.file+'\');">Scan</button>'
        },
        "targets": 7
    }]

});

//前台添加序号
t.on('order.dt search.dt',
function() {
    t.column(0, {
        "search": 'applied',
        "order": 'applied'
    }).nodes().each(function(cell, i) {
        cell.innerHTML = i + 1;
    });
}).draw();

// //更换数据源（相同格式，但是数据内容不同）
// $("#redraw").click(function() {
//     var url = table.api().ajax().url("../../scan/api/?action=loglist");
//     url.load();
// });

//显示内容
function showlog(file) {
  $('#frame_progress').show()
  $.ajax( {
    url:'../../scan/api/?action=loglist',// 跳转到 action
    data: {
        'action': 'getlog',
        'file': file,
    },
    async : true,
    success:function(data) {
      document.getElementById('frame_content').contentWindow.document.open()
      document.getElementById('frame_content').contentWindow.document.write(JSON.stringify(data));
      document.getElementById('frame_content').contentWindow.document.close()
      $('#frame_progress').hide("fast")
    },
    error : function() {
      document.getElementById('frame_content').contentWindow.document.open()
      document.getElementById('frame_content').contentWindow.document.write('发生错误！');
      document.getElementById('frame_content').contentWindow.document.close()
      $('#frame_progress').hide("fast")
    }
    });
};
</script>
{% endblock %}
